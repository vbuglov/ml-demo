<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Body Segmentation без p5.js</title>
    <!-- Подключаем ml5.js -->
    <script src="https://cdn.jsdelivr.net/npm/ml5@latest/dist/ml5.min.js"></script>
    <style>
        canvas {
            border: 1px solid #000;
        }
    </style>
</head>
<body>
<!-- Канвас для отображения видео и маски -->
<canvas id="canvas" width="640" height="480"></canvas>
<!-- Видеоэлемент (скрыт) -->
<video
        id="video"
        width="640"
        height="480"
        autoplay
        muted
        playsinline
        style="display: none;"
></video>

<script>
  let bodySegmentation;
  let video;
  let segmentation;

  const options = {
    maskType: "parts"
  };

  // Инициализация видео с веб-камеры
  function initVideo() {
    video = document.getElementById("video");
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices
        .getUserMedia({ video: { width: 640, height: 480 } })
        .then((stream) => {
          video.srcObject = stream;
          video.onloadedmetadata = () => {
            video.play();
            // После запуска видео загружаем модель сегментации
            initSegmentation();
          };
        })
        .catch((err) => {
          console.error("Ошибка доступа к веб-камере:", err);
        });
    } else {
      alert("getUserMedia не поддерживается вашим браузером.");
    }
  }

  // Инициализация модели сегментации
  function initSegmentation() {
    bodySegmentation = ml5.bodySegmentation("BodyPix", options, modelLoaded);
  }

  function modelLoaded() {
    console.log("Модель загружена!");
    // Если метод detectStart доступен, запускаем его для непрерывного анализа,
    // иначе используем обычное обнаружение с вызовом detect() в цикле.
    if (bodySegmentation.detectStart) {
      bodySegmentation.detectStart(video, gotResults);
    } else {
      detect();
    }
  }

  // Для случаев, когда detectStart недоступен – функция непрерывного анализа
  function detect() {
    bodySegmentation.segment(video, gotResults);
  }

  // Callback-функция для получения результатов сегментации
  function gotResults(result) {
    segmentation = result;
  }

  // Цикл отрисовки на канвасе
  function drawFrame() {
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // Рисуем текущее изображение с видео
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    }

    // Если получена маска сегментации, накладываем её
    if (segmentation && segmentation.mask) {
      const maskData = segmentation.mask;
      const imageData = new ImageData(new Uint8ClampedArray(maskData.data), maskData.width, maskData.height);

      ctx.putImageData(imageData, 0, 0);
    }

    requestAnimationFrame(drawFrame);
  }

  // Запускаем инициализацию при загрузке окна
  window.onload = function () {
    initVideo();
    drawFrame();
  };
</script>
</body>
</html>
